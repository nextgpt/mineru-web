import{R as d,E,a as V,r as M,b as $,e as u,f as i,h as k,k as H,w as m,i as R,t as I,u as T,p as F,q as w,x as q,y as C,_ as K}from"./index-3p_sB7V1.js";import{f as Q}from"./format-B3wa2IJS.js";import{u as Z}from"./project-CkqIgJ0n.js";import{r as O}from"./ragflow-Cczd1rK0.js";import{A as J}from"./index-DHr9lByg.js";class x{static showParsingCompleted(e,a,t){d({title:"文档解析完成",message:`"${e}" 已成功解析完成，共生成 ${a} 个文档片段。点击查看详情。`,type:"success",duration:8e3,showClose:!0,onClick:t||(()=>{})})}static showParsingFailed(e,a,t){d({title:"文档解析失败",message:`"${e}" 解析失败：${a}。${t?"点击重试。":""}`,type:"error",duration:0,showClose:!0,onClick:t||(()=>{})})}static showParsingProgress(e,a){a%25===0&&a>0&&a<100&&E({message:`"${e}" 解析进度：${a}%`,type:"info",duration:2e3})}static showUploadSuccess(e,a){d({title:"上传成功",message:`"${e}" 已成功上传并开始解析。点击查看项目详情。`,type:"success",duration:5e3,showClose:!0,onClick:a||(()=>{})})}static showUploadFailed(e,a,t){d({title:"上传失败",message:`"${e}" 上传失败：${a}。${t?"点击重试。":""}`,type:"error",duration:0,showClose:!0,onClick:t||(()=>{})})}static showOutlineCompleted(e,a){d({title:"大纲生成完成",message:`"${e}" 的技术方案大纲已生成完成。点击查看详情。`,type:"success",duration:6e3,showClose:!0,onClick:a||(()=>{})})}static showContentCompleted(e,a){d({title:"标书生成完成",message:`"${e}" 的标书内容已生成完成。点击查看和编辑。`,type:"success",duration:6e3,showClose:!0,onClick:a||(()=>{})})}static showRagflowParsingError(e,a,t){let s=`"${e}" 解析失败：${a}`;a.includes("float()")||a.includes("NoneType")?s=`"${e}" 解析配置错误，系统已自动修复配置，请重试。`:a.includes("embedding")&&(s=`"${e}" 向量化处理失败，可能是文档内容过于复杂，请重试。`),t&&(s+=" 点击此通知重试。"),d({title:"RAGFLOW解析错误",message:s,type:"error",duration:0,showClose:!0,onClick:t||(()=>{})})}static show(e){d({title:e.title,message:e.message,type:e.type||"info",duration:e.duration??4500,showClose:e.showClose??!0,onClick:e.onClick||(()=>{})})}static showMessage(e,a="info"){E({message:e,type:a,duration:3e3})}static showError(e){E.error(e)}static showSuccess(e){E.success(e)}static showWarning(e){E.warning(e)}}class N{static handleApiError(e,a=""){return console.error(`[ErrorHandler] ${a}:`,e),e instanceof J?this.handleAxiosError(e,a):e instanceof Error?this.handleGenericError(e,a):{code:"UNKNOWN_ERROR",message:"Unknown error occurred",userMessage:"发生未知错误，请重试",canRetry:!0}}static handleAxiosError(e,a){const t=e.response;if(!t)return{code:"NETWORK_ERROR",message:e.message,userMessage:"网络连接失败，请检查网络设置后重试",canRetry:!0};const s=t.status,r=t.data;switch(s){case 400:return{code:"BAD_REQUEST",message:(r==null?void 0:r.message)||"Bad request",details:r,userMessage:(r==null?void 0:r.message)||"请求参数错误，请检查输入内容",canRetry:!1};case 401:return{code:"UNAUTHORIZED",message:"Unauthorized",userMessage:"API认证失败，请检查配置",canRetry:!1};case 403:return{code:"FORBIDDEN",message:"Forbidden",userMessage:"没有权限执行此操作",canRetry:!1};case 404:return{code:"NOT_FOUND",message:"Resource not found",userMessage:"请求的资源不存在",canRetry:!1};case 413:return{code:"FILE_TOO_LARGE",message:"File too large",userMessage:"文件过大，请选择较小的文件",canRetry:!1};case 429:return{code:"RATE_LIMIT",message:"Too many requests",userMessage:"请求过于频繁，请稍后重试",canRetry:!0};case 500:return{code:"SERVER_ERROR",message:"Internal server error",userMessage:"服务器内部错误，请稍后重试",canRetry:!0};case 502:case 503:case 504:return{code:"SERVICE_UNAVAILABLE",message:"Service unavailable",userMessage:"服务暂时不可用，请稍后重试",canRetry:!0};default:return{code:"HTTP_ERROR",message:`HTTP ${s}: ${(r==null?void 0:r.message)||e.message}`,details:r,userMessage:(r==null?void 0:r.message)||`服务器返回错误 (${s})`,canRetry:s>=500}}}static handleGenericError(e,a){return e.message.includes("timeout")?{code:"TIMEOUT_ERROR",message:e.message,userMessage:"操作超时，请重试",canRetry:!0}:e.message.includes("file")||e.message.includes("upload")?{code:"FILE_ERROR",message:e.message,userMessage:"文件处理失败："+e.message,canRetry:!0}:e.message.includes("parsing")||e.message.includes("parse")?{code:"PARSING_ERROR",message:e.message,userMessage:"文档解析失败："+e.message,canRetry:!0}:{code:"GENERIC_ERROR",message:e.message,userMessage:e.message||"操作失败，请重试",canRetry:!0}}static showError(e,a="",t=!1){const s=this.handleApiError(e,a);return t?d({title:"操作失败",message:s.userMessage,type:"error",duration:0,showClose:!0}):E.error(s.userMessage),s}static showErrorWithRetry(e,a="",t){const s=this.handleApiError(e,a);return s.canRetry&&t?d({title:"操作失败",message:`${s.userMessage}
点击此通知重试`,type:"error",duration:0,showClose:!0,onClick:t}):d({title:"操作失败",message:s.userMessage,type:"error",duration:0,showClose:!0}),s}static handleUploadError(e,a,t){const s=this.handleApiError(e,"File Upload");return s.code==="FILE_TOO_LARGE"?s.userMessage=`文件 "${a}" 过大，请选择小于200MB的文件`:s.code==="BAD_REQUEST"&&s.message.includes("format")&&(s.userMessage=`文件 "${a}" 格式不支持，请选择PDF或Word文档`),this.showErrorWithRetry(s,"File Upload",t),s}static handleParsingError(e,a,t){const s=this.handleApiError(e,"Document Parsing");return s.message.includes("timeout")?s.userMessage=`文档 "${a}" 解析超时，可能文档过大或内容复杂，请重试`:s.message.includes("format")?(s.userMessage=`文档 "${a}" 格式不支持或已损坏，请检查文档`,s.canRetry=!1):s.message.includes("float()")||s.message.includes("NoneType")?(s.userMessage=`文档 "${a}" 解析配置错误，系统正在重试`,s.canRetry=!0):s.message.includes("embedding")&&(s.userMessage=`文档 "${a}" 向量化处理失败，请重试`,s.canRetry=!0),this.showErrorWithRetry(s,"Document Parsing",t),s}static handleOutlineError(e,a,t){const s=this.handleApiError(e,"Outline Generation");return s.userMessage=`项目 "${a}" 大纲生成失败：${s.userMessage}`,this.showErrorWithRetry(s,"Outline Generation",t),s}static handleContentError(e,a,t){const s=this.handleApiError(e,"Content Generation");return s.userMessage=`项目 "${a}" 内容生成失败：${s.userMessage}`,this.showErrorWithRetry(s,"Content Generation",t),s}static validateFile(e){if(e.size>209715200)return{valid:!1,error:"文件大小不能超过200MB"};const t=[".pdf",".doc",".docx"],s=e.name.toLowerCase().substring(e.name.lastIndexOf("."));return t.includes(s)?e.name.length>100?{valid:!1,error:"文件名过长，请使用较短的文件名"}:{valid:!0}:{valid:!1,error:`不支持的文件类型，仅支持：${t.join("、")}`}}}const X={class:"upload-root"},Y={class:"upload-card"},ee={key:0,class:"upload-progress"},se={class:"progress-header"},ae={class:"progress-title"},te={key:0,class:"progress-details"},re={key:1,class:"upload-list"},oe={class:"upload-list-header"},ne=V({__name:"Upload",setup(U){const e=q(),a=Z(),t=M([]),s=M(!1),r=M(0),h=M("normal"),_=M(""),g=M(""),b=M(),A=n=>{const o=N.validateFile(n);return o.valid?!0:(E.error(o.error),!1)},z=n=>{A(n.raw)&&(t.value=[{name:n.name,size:n.size,raw:n.raw}])},D=n=>{var o;t.value=[],(o=b.value)==null||o.clearFiles()},B=n=>({normal:"info",success:"success",error:"danger"})[n]||"info",G=n=>({normal:"处理中",success:"完成",error:"失败"})[n]||"处理中",L=()=>`project_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,S=async()=>{var o;if(t.value.length===0){E.warning("请先选择要上传的文件");return}const n=t.value[0];s.value=!0,r.value=0,h.value="normal";try{const l=L(),p={id:l,name:n.name.replace(/\.[^/.]+$/,""),fileName:n.name,fileSize:n.size,uploadTime:new Date().toISOString(),status:"uploading",lastModified:new Date().toISOString()};a.addProject(p),_.value="创建数据集...",g.value="正在为您的招标文档创建专用数据集",r.value=20;const c=await O.createDataset(p.name);console.log("[Upload] Dataset created:",c),a.updateProject(l,{datasetId:c.id,status:"uploading"}),_.value="上传文档...",g.value="正在将文档上传到知识库",r.value=50;const f=await O.uploadDocument(c.id,n.raw);console.log("[Upload] Document uploaded:",f),a.updateProject(l,{documentId:f.id,status:"parsing"}),_.value="解析文档...",g.value="正在解析文档内容，提取关键信息",r.value=70,await O.parseDocument(c.id,[f.id]),console.log("[Upload] Document parsing started"),await O.waitForDocumentParsing(c.id,f.id,(y,v)=>{r.value=70+y*.3,v&&(g.value=v)},(y,v)=>{_.value=v}),_.value="上传完成",g.value="文档已成功上传并解析完成",r.value=100,h.value="success",a.updateProject(l,{status:"ready",lastModified:new Date().toISOString()}),x.showUploadSuccess(p.name,()=>e.push(`/preview/${l}`)),t.value=[],(o=b.value)==null||o.clearFiles(),setTimeout(()=>{e.push(`/preview/${l}`)},1500)}catch(l){console.error("[Upload] Upload failed:",l),h.value="error",_.value="上传失败";const p=l.message||"";if(p.includes("float()")||p.includes("NoneType")||p.includes("embedding"))x.showRagflowParsingError(n.name,p,()=>S()),g.value="RAGFLOW解析配置错误，请重试";else{const c=N.handleUploadError(l,n.name,()=>S());g.value=c.userMessage}if(t.value.length>0){const c=t.value[0].name.replace(/\.[^/.]+$/,""),f=a.projects.find(y=>y.name===c);f&&a.updateProject(f.id,{status:"error",lastModified:new Date().toISOString()})}}finally{setTimeout(()=>{s.value=!1,r.value=0,h.value="normal",_.value="",g.value=""},3e3)}};return(n,o)=>{const l=R("el-icon"),p=R("el-upload"),c=R("el-tag"),f=R("el-progress"),y=R("el-button"),v=R("el-table-column"),W=R("el-table"),j=R("el-empty");return C(),$("div",X,[u("div",Y,[o[5]||(o[5]=u("div",{class:"upload-header"},[u("span",{class:"upload-title"},"点击或拖拽上传招标文档")],-1)),i(p,{ref_key:"uploadRef",ref:b,class:"upload-area",drag:"","auto-upload":!1,"on-change":z,"on-remove":D,"before-upload":A,accept:".pdf,.doc,.docx",limit:1,disabled:s.value},{tip:m(()=>o[0]||(o[0]=[u("div",{class:"el-upload__tip"},[w(" 支持的文件类型：PDF、Word文档（.doc, .docx） "),u("br"),w(" 单个文档不超过 "),u("b",null,"200MB"),w("，系统将自动解析文档内容 ")],-1)])),default:m(()=>[i(l,{class:"el-icon--upload"},{default:m(()=>[i(T(F))]),_:1}),o[1]||(o[1]=u("div",{class:"el-upload__text"},[w(" 拖拽招标文档到此处，或 "),u("span",{class:"upload-link"},"点击上传")],-1))]),_:1,__:[1]},8,["disabled"]),s.value?(C(),$("div",ee,[u("div",se,[u("span",ae,I(_.value),1),i(c,{type:B(h.value),size:"small"},{default:m(()=>[w(I(G(h.value)),1)]),_:1},8,["type"])]),i(f,{percentage:r.value,status:h.value==="error"?"exception":h.value==="success"?"success":void 0,"stroke-width":8},null,8,["percentage","status"]),g.value?(C(),$("div",te,I(g.value),1)):k("",!0)])):k("",!0),t.value.length>0&&!s.value?(C(),$("div",re,[u("div",oe,[o[3]||(o[3]=u("span",null,"待上传文件",-1)),i(y,{type:"primary",onClick:S,disabled:t.value.length===0,size:"small"},{default:m(()=>[i(l,null,{default:m(()=>[i(T(F))]),_:1}),o[2]||(o[2]=w(" 开始上传 "))]),_:1,__:[2]},8,["disabled"])]),i(W,{data:t.value,border:"",stripe:""},{default:m(()=>[i(v,{prop:"name",label:"文件名"}),i(v,{prop:"size",label:"大小",width:"120"},{default:m(({row:P})=>[w(I(T(Q)(P.size)),1)]),_:1}),i(v,{label:"操作",width:"120"},{default:m(({row:P})=>[i(y,{type:"danger",link:"",onClick:le=>D(P)},{default:m(()=>o[4]||(o[4]=[w(" 删除 ")])),_:2,__:[4]},1032,["onClick"])]),_:1})]),_:1},8,["data"])])):s.value?k("",!0):(C(),H(j,{key:2,description:"暂无待上传文件，请选择招标文档开始智能标书生成！","image-size":100,class:"upload-empty"}))])])}}}),pe=K(ne,[["__scopeId","data-v-3cbe59bb"]]);export{pe as default};
