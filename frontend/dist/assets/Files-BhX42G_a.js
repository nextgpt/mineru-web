import{p as ue,a as me,j as y,q as _e,o as ge,v as fe,x as M,c as B,b as g,k as F,f as n,w as s,r as c,E as _,e as u,F as P,y as j,t as w,u as D,g as ve,m as be,z as he,A as ye,i as k,_ as we}from"./index-Cwtstl6k.js";import{a as v,g as C}from"./user-COjPqb4h.js";import{r as ke}from"./jszip.min-CVaBfHD0.js";import{f as Ce}from"./format-B3wa2IJS.js";var xe=ke();const ze=ue(xe),Ue={class:"files-root"},Ee={class:"files-card"},$e={class:"files-header"},Le={class:"files-header-actions"},Re={class:"files-toolbar"},Se={style:{display:"flex","align-items":"center",gap:"8px"}},Ie={class:"pagination-container"},Fe=3e3,Be=me({__name:"Files",setup(Ne){const m=y([]),U=y(0),E=y(!1),$=y(null),l=_e({page:1,pageSize:10,search:"",status:""}),L=y(""),R=y(!1),S=y([]),X=he(),N={MARKDOWN:"markdown",MARKDOWN_PAGE:"markdown_page"},b={[N.MARKDOWN]:"Markdown",[N.MARKDOWN_PAGE]:"Markdown带页码"},K=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}):"",W=t=>({pending:"info",parsing:"warning",parsed:"success",parse_failed:"danger"})[t]||"info",G=t=>({pending:"等待解析",parsing:"解析中",parsed:"已完成",parse_failed:"解析失败"})[t]||"未知状态",q=t=>{switch(t){case"pipeline":return"Pipeline";case"vlm":return"VLM";default:return""}},J=t=>{switch(t){case"pipeline":return"#409EFF";case"vlm":return"#67C23A";default:return"#909399"}},Z=t=>{X.push({name:"FilePreview",params:{id:t.id}})},H=async(t,e)=>{if(!(!t||L.value===t.id)){L.value=t.id;try{const o=await v.get(`/api/files/${t.id}/export`,{params:{format:e},headers:{"X-User-Id":C()}});if(o.data.status==="success"){const p=await(await fetch(o.data.download_url)).blob(),r=window.URL.createObjectURL(p),d=document.createElement("a");d.href=r,d.download=o.data.filename,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(r),document.body.removeChild(d),_.success(`导出${b[e]}成功`)}else _.error(`导出${b[e]}失败`)}catch(o){console.error("导出失败:",o),_.error(`导出${b[e]}失败`)}finally{L.value=""}}},V=()=>{$.value&&(clearInterval($.value),$.value=null)},Q=t=>{if(m.value.length!==t.length){m.value=t;return}t.forEach((e,o)=>{const i=m.value[o];i.id===e.id&&i.status!==e.status&&(m.value[o]=e)})},Y=()=>{console.log("开始轮询..."),V(),$.value=window.setInterval(async()=>{await ee()},Fe)},ee=async()=>{try{const t=await v.get("/api/files",{params:{page:l.page,page_size:l.pageSize,search:l.search,status:l.status},headers:{"X-User-Id":C()}});Q(t.data.files),U.value=t.data.total}catch(t){console.error("轮询获取文件列表失败:",t)}},z=async()=>{E.value=!0;try{const t=await v.get("/api/files",{params:{page:l.page,page_size:l.pageSize,search:l.search,status:l.status},headers:{"X-User-Id":C()}});m.value=t.data.files,U.value=t.data.total}catch{_.error("获取文件列表失败"),m.value=[],U.value=0}finally{E.value=!1}},te=t=>{ye.confirm("确定要删除该文件吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await v.delete(`/api/files/${t.id}`,{headers:{"X-User-Id":C()}}),_.success("删除成功"),z()}catch{_.error("删除失败")}}).catch(()=>{})},ae=async t=>{try{const e=await v.get(`/api/files/${t.id}/download_url`,{headers:{"X-User-Id":C()}}),o=await v.get(e.data.url,{responseType:"blob"}),i=new Blob([o.data]),p=window.URL.createObjectURL(i),r=document.createElement("a");r.href=p,r.download=t.filename,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(p),document.body.removeChild(r)}catch{_.error("下载失败")}},ne=async t=>{if(!(!S.value.length||R.value)){R.value=!0;try{const e=new ze;for(const r of S.value)try{const d=await v.get(`/api/files/${r.id}/export`,{params:{format:t},headers:{"X-User-Id":C()}});if(d.data.status==="success"){const h=await(await fetch(d.data.download_url)).blob();e.file(d.data.filename,h)}}catch(d){console.error(`导出文件 ${r.filename} 失败:`,d),_.error(`导出文件 ${r.filename} 失败`)}const o=await e.generateAsync({type:"blob"}),i=window.URL.createObjectURL(o),p=document.createElement("a");p.href=i,p.download=`batch_export_${new Date().getTime()}.zip`,document.body.appendChild(p),p.click(),window.URL.revokeObjectURL(i),document.body.removeChild(p),_.success(`批量导出${b[t]}完成`)}catch(e){console.error("批量导出失败:",e),_.error(`批量导出${b[t]}失败`)}finally{R.value=!1}}},se=t=>{S.value=t},le=async t=>{try{await v.post(`/api/files/${t.id}/parse`,{},{headers:{"X-User-Id":C()}}),_.success("解析任务已提交");const e=m.value.findIndex(o=>o.id===t.id);e!==-1&&(m.value[e]={...m.value[e],status:"parsing"})}catch{_.error("解析任务提交失败")}},I=()=>{z()},oe=()=>{l.page=1,z()};return ge(()=>{z().then(()=>{Y()})}),fe(()=>{V()}),M([()=>l.search,()=>l.status],()=>{oe()}),M([()=>l.page,()=>l.pageSize],()=>{z()}),(t,e)=>{const o=c("el-icon"),i=c("el-button"),p=c("el-dropdown-item"),r=c("el-dropdown-menu"),d=c("el-dropdown"),O=c("el-input"),h=c("el-option"),ie=c("el-select"),x=c("el-table-column"),T=c("el-tag"),re=c("el-table"),de=c("el-empty"),ce=c("el-skeleton"),pe=c("el-pagination");return k(),B("div",Ue,[g("div",Ee,[g("div",$e,[e[9]||(e[9]=g("span",{class:"files-title"},"文件列表",-1)),g("div",Le,[n(d,{onCommand:ne,disabled:!S.value.length},{dropdown:s(()=>[n(r,null,{default:s(()=>[(k(),B(P,null,j(b,(a,f)=>n(p,{key:f,command:f},{default:s(()=>[u(w(a),1)]),_:2},1032,["command"])),64))]),_:1})]),default:s(()=>[n(i,{type:"info",size:"large",class:"batch-export-btn",loading:R.value,plain:""},{default:s(()=>[n(o,null,{default:s(()=>e[5]||(e[5]=[g("i",{class:"el-icon-download"},null,-1)])),_:1,__:[5]}),e[7]||(e[7]=u(" 批量导出 ")),n(o,null,{default:s(()=>e[6]||(e[6]=[g("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[6]})]),_:1,__:[7]},8,["loading"])]),_:1},8,["disabled"]),n(i,{type:"primary",size:"large",class:"upload-btn",onClick:e[0]||(e[0]=a=>t.$router.push("/upload"))},{default:s(()=>[n(o,null,{default:s(()=>[n(D(ve))]),_:1}),e[8]||(e[8]=u(" 上传文件 "))]),_:1,__:[8]})])]),g("div",Re,[n(O,{modelValue:l.search,"onUpdate:modelValue":e[1]||(e[1]=a=>l.search=a),placeholder:"请输入文件名称",class:"search-input",clearable:"","prefix-icon":"Search",onInput:I},null,8,["modelValue"]),n(ie,{modelValue:l.status,"onUpdate:modelValue":e[2]||(e[2]=a=>l.status=a),placeholder:"筛选状态",class:"status-select",clearable:"",onChange:I},{default:s(()=>[n(h,{label:"全部",value:""}),n(h,{label:"等待解析",value:"pending"}),n(h,{label:"解析中",value:"parsing"}),n(h,{label:"已完成",value:"parsed"}),n(h,{label:"解析失败",value:"parse_failed"})]),_:1},8,["modelValue"])]),m.value&&m.value.length>0&&!E.value?(k(),F(re,{key:0,data:m.value,border:"",stripe:"",onSelectionChange:se},{default:s(()=>[n(x,{type:"selection",width:"48"}),n(x,{prop:"filename",label:"文件名称"},{default:s(({row:a})=>[g("div",Se,[a.backend?(k(),F(T,{key:0,size:"small",color:J(a.backend),style:{color:"white",border:"none",padding:"0 6px",height:"20px","line-height":"20px"}},{default:s(()=>[u(w(q(a.backend)),1)]),_:2},1032,["color"])):be("",!0),g("span",null,w(a.filename),1)])]),_:1}),n(x,{prop:"size",label:"大小",width:"120"},{default:s(({row:a})=>[u(w(D(Ce)(a.size)),1)]),_:1}),n(x,{prop:"uploadTime",label:"创建时间",width:"180"},{default:s(({row:a})=>[u(w(K(a.upload_time)),1)]),_:1}),n(x,{prop:"status",label:"状态",width:"120"},{default:s(({row:a})=>[n(T,{type:W(a.status)},{default:s(()=>[u(w(G(a.status)),1)]),_:2},1032,["type"])]),_:1}),n(x,{label:"操作",width:"260"},{default:s(({row:a})=>[n(i,{type:"primary",link:"",onClick:f=>Z(a)},{default:s(()=>e[10]||(e[10]=[u("查看")])),_:2,__:[10]},1032,["onClick"]),n(i,{type:"success",link:"",onClick:f=>ae(a)},{default:s(()=>e[11]||(e[11]=[u("下载")])),_:2,__:[11]},1032,["onClick"]),n(i,{type:"danger",link:"",onClick:f=>te(a)},{default:s(()=>e[12]||(e[12]=[u("删除")])),_:2,__:[12]},1032,["onClick"]),n(i,{type:"warning",link:"",onClick:f=>le(a),disabled:a.status==="parsed"||a.status==="parsing",title:a.status==="parsed"?"文件已解析完成":a.status==="parsing"?"文件正在解析中":"开始解析"},{default:s(()=>e[13]||(e[13]=[u("解析")])),_:2,__:[13]},1032,["onClick","disabled","title"]),n(d,{onCommand:f=>H(a,f)},{dropdown:s(()=>[n(r,null,{default:s(()=>[(k(),B(P,null,j(b,(f,A)=>n(p,{key:A,command:A},{default:s(()=>[u(w(f),1)]),_:2},1032,["command"])),64))]),_:1})]),default:s(()=>[n(i,{type:"info",link:"",loading:L.value===a.id},{default:s(()=>[e[15]||(e[15]=u(" 导出 ")),n(o,null,{default:s(()=>e[14]||(e[14]=[g("i",{class:"el-icon-arrow-down"},null,-1)])),_:1,__:[14]})]),_:2,__:[15]},1032,["loading"])]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])):E.value?(k(),F(ce,{key:2,rows:6,animated:"",style:{margin:"32px 0"}})):(k(),F(de,{key:1,description:"暂无数据","image-size":80,class:"files-empty"})),g("div",Ie,[n(pe,{"current-page":l.page,"onUpdate:currentPage":e[3]||(e[3]=a=>l.page=a),"page-size":l.pageSize,"onUpdate:pageSize":e[4]||(e[4]=a=>l.pageSize=a),total:U.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:I,onCurrentChange:I},null,8,["current-page","page-size","total"])])])])}}}),Me=we(Be,[["__scopeId","data-v-e59330ab"]]);export{Me as default};
